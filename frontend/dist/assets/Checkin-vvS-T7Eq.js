import{e as J,u as X,g as i,h as Z,p as ee,c as f,o as x,a as t,m as A,q as _,i as k,l as C,d as F,n as te,t as ae}from"./index-0FmNQmS6.js";import{a as B}from"./api-AP74rUlr.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"min-h-screen bg-white flex flex-col"},re={key:0,class:"flex-1 flex items-center justify-center p-8"},oe={class:"max-w-2xl w-full text-center space-y-12 animate-fade-in"},ne={class:"flex justify-center py-8"},ie=["disabled"],de={class:"max-w-md mx-auto space-y-6"},ce={class:"relative"},ue=["disabled"],fe=["disabled"],xe={key:0},ve={key:1},pe={key:0,class:"text-center"},me={key:1,class:"flex-1 flex items-center justify-center p-8"},ge={class:"max-w-3xl w-full animate-fade-in"},ye={class:"bg-white rounded-3xl shadow-2xl p-8 border border-gray-100"},be={class:"space-y-4"},he={class:"grid grid-cols-2 gap-4"},we=["value"],ke={class:"grid grid-cols-2 gap-4"},Ce=["placeholder"],De={key:0,class:"bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start gap-3"},Ie={class:"flex gap-4 mt-8"},Ae={key:2,class:"flex-1 flex items-center justify-center p-8"},Be={class:"max-w-2xl w-full text-center space-y-12 animate-fade-in"},Ne={class:"bg-gradient-to-br from-primary/10 to-primary/5 p-12 rounded-3xl border-2 border-dashed border-primary/30 inline-block mx-auto"},je={class:"text-8xl font-black text-primary tracking-tighter"},Ee={key:3,class:"fixed inset-0 bg-black z-50 flex flex-col"},ze={class:"flex-1 relative flex items-center justify-center"},Fe={class:"p-6 bg-gray-900/90 backdrop-blur"},Ve=["disabled"],Pe={key:0,class:"flex items-center gap-2"},Ue={key:1,class:"flex items-center gap-2"},Re={key:4,class:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in"},Se={class:"bg-white rounded-3xl max-w-md w-full p-8 text-center shadow-2xl"},_e={class:"space-y-3"},Me=J({__name:"Checkin",setup(Te){const o=X(),N=i(!1),b=i(!1),v=i(""),y=i(!1),V=i(""),l=i({documentId:"",fullName:"",birthDate:"",sex:"",address:""}),H=Z(()=>{if(!l.value.birthDate)return"";try{const s=l.value.birthDate.split("/");if(s.length!==3)return"";const e=new Date(parseInt(s[2]),parseInt(s[1])-1,parseInt(s[0])),a=new Date;let c=a.getFullYear()-e.getFullYear();const n=a.getMonth()-e.getMonth();return(n<0||n===0&&a.getDate()<e.getDate())&&c--,`${c} aÃ±os`}catch{return""}}),P=i(!1),j=i(!1),D=i(!1),I=i(null),U=i(null),h=i(null),d=i(!1),M=i(null),T=async(s=!1)=>{const e=typeof s=="boolean"?s:!1;D.value=e,await L()||(console.log("Camera not available or denied, showing fallback modal"),j.value=!0)},L=async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.warn("Media Devices API not available. Likely due to insecure context (HTTP) or unsupported browser."),!1;try{return h.value=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),P.value=!0,setTimeout(()=>{I.value&&h.value&&(I.value.srcObject=h.value)},100),!0}catch(s){return console.error("Camera error:",s),!1}},E=()=>{h.value&&(h.value.getTracks().forEach(s=>s.stop()),h.value=null),P.value=!1},O=async s=>{d.value=!0;try{const e=new FileReader;e.onload=async a=>{var c,n,p;try{const r=new Image;r.src=(c=a.target)==null?void 0:c.result,r.onload=async()=>{const m=document.createElement("canvas"),z=m.getContext("2d");if(!z){o.error("Error al procesar la imagen"),d.value=!1;return}let w=r.width,u=r.height;const S=1920;w>S&&(u=u*S/w,w=S),m.width=w,m.height=u,z.drawImage(r,0,0,w,u);const G=m.toDataURL("image/jpeg",.7),g=(await B.post("/vision/analyze-document",{image:G})).data;if(D.value)g.address?(l.value.address=g.address,o.success("DirecciÃ³n detectada y actualizada")):o.warning("No se pudo detectar la direcciÃ³n en la imagen");else{if(!g.documentId)throw new Error("No se pudo detectar el nÃºmero de documento. Intente nuevamente con una imagen mÃ¡s clara.");l.value={documentId:g.documentId,fullName:g.fullName,birthDate:g.birthDate,sex:g.sex,address:g.address||""}}b.value=!0,D.value=!1}}catch(r){console.error("Vision AI error:",r),o.error(((p=(n=r.response)==null?void 0:n.data)==null?void 0:p.error)||r.message||"Error al analizar la imagen")}finally{d.value=!1}},e.onerror=()=>{o.error("Error al leer el archivo"),d.value=!1},e.readAsDataURL(s)}catch(e){console.error("File processing error:",e),o.error("Error al procesar la imagen"),d.value=!1}},W=s=>{var c;const a=(c=s.target.files)==null?void 0:c[0];if(a){if(!a.type.startsWith("image/")){o.error("Por favor selecciona una imagen vÃ¡lida");return}O(a)}},q=()=>{var s;(s=M.value)==null||s.click()},K=async()=>{var s,e;if(!(!I.value||!U.value)){d.value=!0;try{const a=U.value,c=I.value;let n=c.videoWidth,p=c.videoHeight;const r=1920;n>r&&(p=p*r/n,n=r),a.width=n,a.height=p;const m=a.getContext("2d");if(m){m.drawImage(c,0,0,n,p);const z=a.toDataURL("image/jpeg",.7),u=(await B.post("/vision/analyze-document",{image:z})).data;if(D.value)u.address?(l.value.address=u.address,o.success("DirecciÃ³n detectada y actualizada")):o.warning("No se pudo detectar la direcciÃ³n en la imagen");else{if(!u.documentId)throw new Error("No se pudo detectar el nÃºmero de documento. Intente nuevamente.");l.value={documentId:u.documentId,fullName:u.fullName,birthDate:u.birthDate,sex:u.sex,address:u.address||""}}E(),b.value=!0,D.value=!1}}catch(a){console.error("Vision AI error:",a),o.error(((e=(s=a.response)==null?void 0:s.data)==null?void 0:e.error)||"Error al analizar la imagen")}finally{d.value=!1}}},R=async()=>{if(!v.value||v.value.length<8||v.value.length>9){o.warning("Por favor ingrese un DNI (8 dÃ­gitos) o Carnet de ExtranjerÃ­a (9 dÃ­gitos) vÃ¡lido");return}y.value=!0;try{const s=await B.get(`/patients?documentId=${v.value}`);if(s.data.length===0){o.error("Paciente no encontrado. Por favor verifique su documento."),y.value=!1;return}const e=s.data[0],a=new Date().toISOString().split("T")[0],n=(await B.get(`/appointments?patientId=${e.id}&date=${a}`)).data.filter(m=>m.status==="SCHEDULED");if(n.length===0){o.warning("No tiene citas programadas para hoy o ya realizÃ³ el check-in."),y.value=!1;return}const p=n[0],r=await B.post(`/appointments/${p.id}/checkin`);V.value=r.data.ticketNumber,N.value=!0,setTimeout(()=>{$()},1e4)}catch(s){console.error(s),o.error("Error al realizar check-in. Intente nuevamente.")}finally{y.value=!1}},Q=async()=>{v.value=l.value.documentId,b.value=!1,await R()},$=()=>{N.value=!1,b.value=!1,v.value="",V.value="",l.value={documentId:"",fullName:"",birthDate:"",sex:"",address:""},E()},Y=s=>{s.key==="Enter"&&R()};return ee(()=>{E()}),(s,e)=>(x(),f("div",le,[e[36]||(e[36]=t("header",{class:"px-8 py-6 border-b border-gray-100"},[t("div",{class:"flex items-center gap-3"},[t("div",{class:"w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-xl"}," I "),t("span",{class:"text-xl font-semibold text-gray-800"},"Instituto OncolÃ³gico")])],-1)),!N.value&&!b.value?(x(),f("div",re,[t("div",oe,[e[13]||(e[13]=t("div",null,[t("h1",{class:"text-5xl font-bold text-gray-900 mb-4"},"Bienvenido a Onkos"),t("p",{class:"text-xl text-gray-600"},"Haz clic en la credencial para escanear tu documento")],-1)),t("div",ne,[t("button",{onClick:T,disabled:d.value,class:"relative group transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-primary/30 rounded-3xl disabled:opacity-50 disabled:cursor-not-allowed"},[...e[9]||(e[9]=[_('<svg width="280" height="180" viewBox="0 0 240 160" fill="none" xmlns="http://www.w3.org/2000/svg" class="drop-shadow-2xl group-hover:drop-shadow-xl transition-all" data-v-f8f3c384><rect x="10" y="15" width="220" height="130" rx="12" fill="#F4F6F8" stroke="#2BB88A" stroke-width="3" class="group-hover:fill-green-50 transition-colors" data-v-f8f3c384></rect><rect x="25" y="30" width="60" height="75" rx="6" fill="#D1D5DB" class="group-hover:fill-gray-400 transition-colors" data-v-f8f3c384></rect><circle cx="55" cy="55" r="15" fill="#9CA3AF" data-v-f8f3c384></circle><path d="M55 70 Q40 90, 55 95 Q70 90, 55 70" fill="#9CA3AF" data-v-f8f3c384></path><rect x="100" y="35" width="110" height="8" rx="4" fill="#2BB88A" opacity="0.6" data-v-f8f3c384></rect><rect x="100" y="50" width="90" height="6" rx="3" fill="#9CA3AF" data-v-f8f3c384></rect><rect x="100" y="63" width="100" height="6" rx="3" fill="#9CA3AF" data-v-f8f3c384></rect><rect x="100" y="76" width="70" height="6" rx="3" fill="#9CA3AF" data-v-f8f3c384></rect><rect x="25" y="115" width="190" height="20" rx="4" fill="white" stroke="#2BB88A" stroke-width="2" data-v-f8f3c384></rect><line x1="35" y1="120" x2="35" y2="130" stroke="#2BB88A" stroke-width="2" data-v-f8f3c384></line><line x1="45" y1="120" x2="45" y2="130" stroke="#2BB88A" stroke-width="3" data-v-f8f3c384></line><line x1="55" y1="120" x2="55" y2="130" stroke="#2BB88A" stroke-width="1" data-v-f8f3c384></line><line x1="65" y1="120" x2="65" y2="130" stroke="#2BB88A" stroke-width="2" data-v-f8f3c384></line><line x1="75" y1="120" x2="75" y2="130" stroke="#2BB88A" stroke-width="3" data-v-f8f3c384></line><line x1="85" y1="120" x2="85" y2="130" stroke="#2BB88A" stroke-width="2" data-v-f8f3c384></line><line x1="95" y1="120" x2="95" y2="130" stroke="#2BB88A" stroke-width="1" data-v-f8f3c384></line><line x1="105" y1="120" x2="105" y2="130" stroke="#2BB88A" stroke-width="3" data-v-f8f3c384></line><line x1="0" y1="75" x2="240" y2="75" stroke="#2BB88A" stroke-width="2" opacity="0" class="group-hover:opacity-40 transition-opacity scan-line" data-v-f8f3c384></line></svg><div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" data-v-f8f3c384><div class="bg-primary text-white px-6 py-3 rounded-full font-semibold text-lg shadow-xl" data-v-f8f3c384> ðŸ“¸ Escanear </div></div>',2)])],8,ie)]),t("div",de,[e[12]||(e[12]=t("div",{class:"text-center mb-4"},[t("p",{class:"text-sm text-gray-500"},"O ingresa tu nÃºmero manualmente:")],-1)),t("div",ce,[e[10]||(e[10]=t("div",{class:"absolute left-5 top-1/2 -translate-y-1/2 text-primary text-2xl"}," ðŸ”¢ ",-1)),k(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>v.value=a),onKeypress:Y,placeholder:"DNI o Carnet",class:"w-full text-center text-3xl py-6 pl-16 pr-6 border-2 border-gray-200 rounded-2xl focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all outline-none tracking-widest font-bold text-gray-700 placeholder-gray-300",disabled:y.value||d.value},null,40,ue),[[C,v.value]])]),t("button",{onClick:R,disabled:y.value||!v.value||d.value,class:"w-full bg-primary text-white py-5 text-xl font-semibold rounded-2xl hover:bg-opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"},[y.value?(x(),f("span",xe,"Verificando...")):(x(),f("span",ve,"Continuar âœ“"))],8,fe),d.value?(x(),f("div",pe,[...e[11]||(e[11]=[_('<div class="flex items-center justify-center gap-3 text-primary" data-v-f8f3c384><svg class="animate-spin h-8 w-8" fill="none" viewBox="0 0 24 24" data-v-f8f3c384><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" data-v-f8f3c384></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" data-v-f8f3c384></path></svg><span class="text-lg font-semibold" data-v-f8f3c384>Analizando imagen con IA...</span></div>',1)])])):A("",!0)]),e[14]||(e[14]=t("div",{class:"text-sm text-gray-500 space-y-2 text-center"},[t("p",{class:"font-medium"},"Haz clic en la credencial para escanear automÃ¡ticamente"),t("p",{class:"text-xs"},"El sistema detectarÃ¡ si usar cÃ¡mara o archivo"),t("p",{class:"text-xs"},"Â¿Necesitas ayuda? AcÃ©rcate al mÃ³dulo de atenciÃ³n.")],-1))])])):b.value&&!N.value?(x(),f("div",me,[t("div",ge,[t("div",ye,[e[22]||(e[22]=t("h2",{class:"text-3xl font-bold text-gray-900 mb-2"},"Verificar Datos del Paciente",-1)),e[23]||(e[23]=t("p",{class:"text-gray-600 mb-8"},"Revise la informaciÃ³n extraÃ­da y confirme para continuar.",-1)),t("div",be,[t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Nombre Completo",-1)),k(t("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=a=>l.value.fullName=a),readonly:"",class:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-medium text-gray-900"},null,512),[[C,l.value.fullName]])]),t("div",he,[t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Fecha de Nacimiento",-1)),k(t("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=a=>l.value.birthDate=a),readonly:"",class:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"},null,512),[[C,l.value.birthDate]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Edad",-1)),t("input",{type:"text",value:H.value,readonly:"",class:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"},null,8,we)])]),t("div",ke,[t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Sexo",-1)),k(t("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=a=>l.value.sex=a),readonly:"",class:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl"},null,512),[[C,l.value.sex]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"NÃºmero de Documento",-1)),k(t("input",{type:"text","onUpdate:modelValue":e[4]||(e[4]=a=>l.value.documentId=a),readonly:"",class:"w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl font-mono"},null,512),[[C,l.value.documentId]])])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700 mb-2"},[F(" DirecciÃ³n "),t("span",{class:"text-gray-400"},"(Opcional)")],-1)),k(t("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=a=>l.value.address=a),placeholder:l.value.address?"":"No detectada - Puedes escanear el reverso",readonly:"",class:te(["w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl",l.value.address?"text-gray-900":"text-gray-400 italic"])},null,10,Ce),[[C,l.value.address]])]),l.value.address?A("",!0):(x(),f("div",De,[...e[21]||(e[21]=[t("span",{class:"text-2xl"},"â„¹ï¸",-1),t("div",{class:"flex-1"},[t("p",{class:"text-sm font-medium text-blue-900"},"DirecciÃ³n no detectada"),t("p",{class:"text-xs text-blue-700 mt-1"},"La direcciÃ³n puede estar en el reverso del documento. Puedes escanear el reverso o continuar sin ella.")],-1)])]))]),t("div",Ie,[l.value.address?A("",!0):(x(),f("button",{key:0,onClick:e[6]||(e[6]=a=>T(!0)),class:"flex-1 bg-blue-500 text-white py-4 text-lg font-semibold rounded-2xl hover:bg-blue-600 transition-all shadow-lg"}," ðŸ“¸ Escanear Reverso ")),t("button",{onClick:Q,class:"flex-1 bg-primary text-white py-4 text-lg font-semibold rounded-2xl hover:bg-opacity-90 transition-all shadow-lg"}," âœ“ Confirmar y Continuar ")])])])])):(x(),f("div",Ae,[t("div",Be,[e[26]||(e[26]=_('<div class="flex justify-center" data-v-f8f3c384><div class="w-32 h-32 bg-green-100 rounded-full flex items-center justify-center" data-v-f8f3c384><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" data-v-f8f3c384><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" data-v-f8f3c384></path></svg></div></div><div data-v-f8f3c384><h1 class="text-5xl font-bold text-gray-900 mb-4" data-v-f8f3c384>Â¡Check-in Exitoso!</h1><p class="text-xl text-gray-600" data-v-f8f3c384>Por favor, toma asiento y espera tu turno</p></div>',2)),t("div",Ne,[e[24]||(e[24]=t("p",{class:"text-sm text-gray-500 uppercase tracking-wider mb-3"},"Tu Turno",-1)),t("p",je,ae(V.value),1)]),t("div",{class:"text-sm text-gray-500"},[e[25]||(e[25]=t("p",null,"Esta pantalla se reiniciarÃ¡ automÃ¡ticamente en unos segundos...",-1)),t("button",{onClick:$,class:"mt-4 text-primary hover:underline"}," Realizar otro check-in ")])])])),P.value?(x(),f("div",Ee,[t("div",{class:"p-6 bg-gray-900/90 backdrop-blur flex items-center justify-between"},[e[27]||(e[27]=t("h2",{class:"text-white text-xl font-semibold"},"Escanear DNI con IA",-1)),t("button",{onClick:E,class:"text-white hover:text-gray-300 text-3xl"},"Ã—")]),t("div",ze,[t("video",{ref_key:"videoRef",ref:I,autoplay:"",playsinline:"",class:"max-w-full max-h-full object-contain"},null,512),e[28]||(e[28]=t("div",{class:"absolute inset-0 flex items-center justify-center pointer-events-none"},[t("div",{class:"border-4 border-primary border-dashed rounded-2xl w-96 h-60 opacity-70"})],-1)),e[29]||(e[29]=t("div",{class:"absolute bottom-32 left-0 right-0 text-center text-white px-4"},[t("p",{class:"text-lg bg-black/50 backdrop-blur py-3 px-6 rounded-full inline-block"}," Coloca tu DNI dentro del recuadro ")],-1))]),t("div",Fe,[t("button",{onClick:K,disabled:d.value,class:"w-full bg-primary text-white py-5 text-xl font-bold rounded-2xl hover:bg-opacity-90 transition-all disabled:opacity-50 flex items-center justify-center gap-3"},[d.value?(x(),f("span",Pe,[...e[30]||(e[30]=[t("svg",{class:"animate-spin h-6 w-6",fill:"none",viewBox:"0 0 24 24"},[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),F(" Analizando con IA... ",-1)])])):(x(),f("span",Ue,[...e[31]||(e[31]=[t("span",{class:"text-2xl"},"ðŸ¤–",-1),F(" Capturar y Analizar ",-1)])]))],8,Ve)]),t("canvas",{ref_key:"canvasRef",ref:U,class:"hidden"},null,512)])):A("",!0),t("input",{ref_key:"fileInputRef",ref:M,type:"file",accept:"image/*",onChange:W,class:"hidden"},null,544),j.value?(x(),f("div",Re,[t("div",Se,[e[33]||(e[33]=t("div",{class:"w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6"},[t("span",{class:"text-4xl"},"ðŸ“·")],-1)),e[34]||(e[34]=t("h3",{class:"text-2xl font-bold text-gray-900 mb-3"},"CÃ¡mara no detectada",-1)),e[35]||(e[35]=t("p",{class:"text-gray-600 mb-8"}," No pudimos acceder a la cÃ¡mara. Por favor selecciona una foto de tu galerÃ­a o archivos. ",-1)),t("div",_e,[t("button",{onClick:e[7]||(e[7]=a=>{q(),j.value=!1}),class:"w-full bg-primary text-white py-4 text-lg font-semibold rounded-2xl hover:bg-opacity-90 transition-all shadow-lg flex items-center justify-center gap-2"},[...e[32]||(e[32]=[t("span",null,"ðŸ“‚",-1),F(" Seleccionar Foto ",-1)])]),t("button",{onClick:e[8]||(e[8]=a=>j.value=!1),class:"w-full bg-gray-100 text-gray-700 py-4 text-lg font-semibold rounded-2xl hover:bg-gray-200 transition-all"}," Cancelar ")])])])):A("",!0)]))}}),We=se(Me,[["__scopeId","data-v-f8f3c384"]]);export{We as default};
